name: ðŸš€ Deploy MatchDay.ro to Hostico

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: json, fileinfo, filter, curl
        
    - name: ðŸ”§ Prepare deployment files
      run: |
        # CreeazÄƒ directoarele necesare dacÄƒ nu existÄƒ
        mkdir -p data/cache data/backups/polls data/comments
        
        # SeteazÄƒ permisiuni corecte pentru fiÈ™ierele de deployment
        find . -type f -name "*.php" -exec chmod 644 {} \;
        find . -type f -name "*.js" -exec chmod 644 {} \;
        find . -type f -name "*.css" -exec chmod 644 {} \;
        find . -type f -name "*.json" -exec chmod 644 {} \;
        
        # CreeazÄƒ .htaccess pentru directorul data dacÄƒ nu existÄƒ
        if [ ! -f data/.htaccess ]; then
          echo "Options -Indexes" > data/.htaccess
        fi
        
    - name: ðŸš€ Deploy to Hostico via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.HOSTICO_FTP_SERVER }}
        username: ${{ secrets.HOSTICO_FTP_USERNAME }}  
        password: ${{ secrets.HOSTICO_FTP_PASSWORD }}
        local-dir: ./
        server-dir: ./public_html/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.vscode/**
          **/.idea/**
          .github/
          README-GITHUB.md
          deploy-hostico.sh
          *.md
          .gitignore
          debug-*.php
          test-*.html
          
    - name: ðŸ§¹ Post-deployment cleanup
      uses: appleboy/ssh-action@v1.0.0
      if: ${{ secrets.HOSTICO_SSH_HOST }}
      with:
        host: ${{ secrets.HOSTICO_SSH_HOST }}
        username: ${{ secrets.HOSTICO_SSH_USERNAME }}
        password: ${{ secrets.HOSTICO_SSH_PASSWORD }}
        port: ${{ secrets.HOSTICO_SSH_PORT || '22' }}
        script: |
          cd public_html/
          
          # SeteazÄƒ permisiuni corecte
          find . -type d -exec chmod 755 {} \;
          find . -type f -exec chmod 644 {} \;
          
          # Permisiuni speciale pentru directoarele de date
          chmod 755 data/
          chmod 755 data/polls/
          chmod 755 data/cache/
          chmod 755 data/backups/
          chmod 755 assets/uploads/
          
          # Clear cache dupÄƒ deployment
          rm -f data/cache/*.cache
          
          # VerificÄƒ cÄƒ fiÈ™ierele importante existÄƒ
          if [ ! -f config/config.php ]; then
            echo "âš ï¸  WARNING: config.php not found! Please configure manually."
          fi
          
          echo "âœ… MatchDay.ro deployed successfully!"
          echo "ðŸŒ Site available at: https://matchday.ro"
          
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸŽ‰ Deployment Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Deployment Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Site:** [MatchDay.ro](https://matchday.ro)" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Actions Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- Files uploaded to Hostico" >> $GITHUB_STEP_SUMMARY
        echo "- Permissions set correctly" >> $GITHUB_STEP_SUMMARY
        echo "- Cache cleared" >> $GITHUB_STEP_SUMMARY
        echo "- Site is live and ready!" >> $GITHUB_STEP_SUMMARY
